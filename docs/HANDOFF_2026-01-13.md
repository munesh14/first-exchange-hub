# Handoff Document - First Exchange Procurement System
**Date:** January 13, 2026
**From:** Claude Code Session
**To:** Claude Desktop (Planning & Architecture)

---

## Session Summary

Successfully set up an **isolated n8n instance** for Invoice/Procurement workflows, separating them from FPS workflows to prevent dependency conflicts (bcrypt issue).

---

## What Was Completed

### 1. n8n-Invoice Instance Setup
- **Location:** `/home/munesh/Documents/n8n_projects/docker-setup/n8n-invoice/`
- **Port:** 5679 (separate from FPS on 5678)
- **Containers:**
  - `n8n-invoice` - Workflow automation (172.30.0.21)
  - `n8n-invoice-db` - PostgreSQL for n8n internal data (172.30.0.31)

### 2. Workflow Migration
All Invoice/Procurement workflows imported to new n8n instance:
- FE Document Chain - API Endpoints
- FE Quotation - API Endpoints
- FE Delivery Order - API Endpoints
- FE Proforma - API Endpoints
- FE Payment - API Endpoints
- FE Asset - API Endpoints

### 3. Chain API Endpoint Tested
```
GET http://172.16.35.76:5679/webhook/chain-api/get?uuid={chainUuid}
```
Returns complete chain details including:
- Chain metadata (number, title, status, amounts)
- Related documents (quotations, LPOs, DOs, invoices, payments)
- Assets linked to chain
- Activity log

### 4. Dashboard API Port Updated
All API files in `/src/lib/` updated from port 5678 to 5679:
- api-chain.ts
- api-quotation.ts
- api-lpo.ts
- api-delivery-order.ts
- api-proforma.ts
- api-payment.ts
- api-asset.ts
- LPOUpload.tsx
- UploadInvoice.tsx

### 5. SQL Query Fixes in n8n
Fixed column name mismatches in workflow SQL queries:
- `StatusID` → `Status` (Quotations)
- `ApprovedAt`, `ApprovedBy`, `ApprovalStatus` → removed (LPOs)
- `DeliveryDate` → `ExpectedDeliveryDate` (LPOs)
- `ReceivedAt` → `ReceivedDate` (Delivery Orders)
- `DueDate` → `PaymentDueDate` (Invoices)
- `PaymentReference` → `ReferenceNumber` (Payments)
- `OldStatus` → `OldStatusID` (Activity Log)

---

## Current Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Development Server                        │
│                    172.16.35.76                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  n8n-workflow   │    │  n8n-invoice    │                │
│  │  (FPS)          │    │  (Procurement)  │                │
│  │  Port: 5678     │    │  Port: 5679     │                │
│  │  172.30.0.20    │    │  172.30.0.21    │                │
│  └────────┬────────┘    └────────┬────────┘                │
│           │                      │                          │
│           └──────────┬───────────┘                          │
│                      │                                      │
│           ┌──────────▼──────────┐                          │
│           │   mssql-server      │                          │
│           │   172.30.0.10       │                          │
│           │   Port: 1433        │                          │
│           └─────────────────────┘                          │
│                                                             │
│  Databases:                                                 │
│  - FirstPaySimplified (FPS)                                │
│  - FE_InvoiceSystem (Procurement)                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Implementation Status

| Phase | Status | Notes |
|-------|--------|-------|
| **Phase 1:** Database & Core APIs | ✅ Complete | Chain APIs working on port 5679 |
| **Phase 2:** Document Management | ⏳ Not Started | File upload/download, PDF generation |
| **Phase 3:** UI - Chain Views | ⏳ Not Started | New chain-centric dashboard |
| **Phase 4:** Historical Upload | ⏳ Not Started | Manual entry, 2024 carryforward |
| **Phase 5:** Testing & Training | ⏳ Not Started | UAT, go-live |

---

## Next Steps (Decision Needed)

### Option A: Phase 2 - Document Management
- Build document upload/download APIs
- Implement LPO PDF generation (using Gotenberg)
- Create payment receipt generator
- Document preview functionality

### Option B: Phase 3 - New Dashboard UI
- Redesign from document-centric to chain-centric
- Chain list view with status filters
- Chain detail view with workflow progress visualization
- Document viewer integrated into chain view

### Option C: Parallel Development
- Work on Document APIs while designing new UI

---

## Key Files & Locations

### n8n-Invoice Docker Setup
```
/home/munesh/Documents/n8n_projects/docker-setup/n8n-invoice/
├── Dockerfile
└── docker-compose.yml
```

### Procurement Dashboard
```
/home/munesh/Documents/dashboards/first-exchange-hub/
├── docs/PROCUREMENT_CHAIN_ARCHITECTURE_v1.2.md  ← Full architecture
├── n8n-workflows/                                ← API workflow specs
├── src/lib/api-*.ts                              ← API modules
└── src/pages/                                    ← UI pages
```

### n8n Workflow Endpoint
```
Base URL: http://172.16.35.76:5679/webhook/
Endpoints:
- POST /chain-api/create
- GET  /chain-api/list
- GET  /chain-api/get?uuid=X
```

---

## Important Notes

1. **Old FE workflows on port 5678 are DISABLED** - Do not re-enable to avoid conflicts

2. **bcrypt issue** - FPS workflows require bcrypt which was deleted when rebuilding n8n. This is why we isolated to n8n-invoice.

3. **Dashboard not rebuilt yet** - API ports updated in source code but container not rebuilt

4. **Architecture document** - Complete system design in `docs/PROCUREMENT_CHAIN_ARCHITECTURE_v1.2.md`

---

## Commands Reference

### Start n8n-invoice
```bash
cd /home/munesh/Documents/n8n_projects/docker-setup/n8n-invoice
docker compose up -d
```

### Test Chain API
```bash
curl -s "http://172.16.35.76:5679/webhook/chain-api/get?uuid=97700A97-AE90-42C3-BD2B-88A706107F81" | jq
```

### Rebuild Dashboard
```bash
cd /home/munesh/Documents/n8n_projects/docker-setup
docker compose build --no-cache fe-dashboard
docker compose up -d fe-dashboard
```

### Access n8n UI
- FPS (old): http://172.16.35.76:5678
- Invoice (new): http://172.16.35.76:5679

---

## Git Status

**Last Commit:** `c5864ed` - "Add procurement chain system with isolated n8n instance"
**Branch:** main (4 commits ahead of origin)
**Pending:** Not pushed to remote yet

---

*Generated by Claude Code - January 13, 2026*
